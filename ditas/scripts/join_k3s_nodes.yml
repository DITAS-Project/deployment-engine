---
  - hosts: [master]
    become: yes
    gather_facts: no
    tasks:
      - name: Wait until token file is ready
        wait_for:
          path: /var/lib/rancher/k3s/server/node-token
      - name: Get join token
        shell: cat /var/lib/rancher/k3s/server/node-token
        register: join_token_out

      - name: Setting variable to join other nodes
        set_fact: 
          join_token: "{{ join_token_out.stdout }}"

  - hosts: [slaves]
    become: yes
    gather_facts: no
    tasks:
      - name: Set startup options for joining
        set_fact:
          init_options: agent --server https://{{ master_ip }}:6443 --token "{{ hostvars[groups['master'][0]]['join_token'] }}"
      - name: Copy systemd unit
        template: 
          src: k3s.service
          dest: /etc/systemd/system/k3s.service
      - name: Enable k3s service
        systemd:
          name: k3s
          state: started
          enabled: yes
          daemon_reload: yes