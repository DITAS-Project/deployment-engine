---
  - hosts: [all]
    become: yes
    gather_facts: no
    tasks:
      - name: Create data partitions
        parted: 
          device: "{{ item }}"
          number: 1
          state: present
        loop: "{{ hostvars[inventory_hostname].devices }}"


      - name: Format data partitions
        filesystem:
          fstype: ext4
          dev: "{{ item }}1"
        loop: "{{ hostvars[inventory_hostname].devices }}"
      
      - name: Mount data partitions
        mount:
          path: "/var/lib/storageos/data/dev{{ dev_idx }}"
          src: "{{ item }}1"
          fstype: ext4
          state: mounted
        loop: "{{ hostvars[inventory_hostname].devices }}"
        loop_control: 
          index_var: dev_idx